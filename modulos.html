<!DOCTYPE html>

<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Módulos dos Cursos</title>


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;600&amp;display=swap" rel="stylesheet"/>
<style>
    body {
      background: #f4f6f9;
      font-family: 'Raleway', sans-serif;
      padding-top: 90px;
    }
    .navbar {
      background-color: #03665c;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      margin-bottom: 30px;
    }
    .navbar-brand, .nav-link {
      color: #fff !important;
      font-size: 1.05rem;
    }
    .nav-link.active {
      border-bottom: 3px solid #fff;
    }
    .gradient-box {
      color: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .bg-grad-1 { background: linear-gradient(135deg, #0D47A1, #1976D2); }
    .bg-grad-2 { background: linear-gradient(135deg, #C62828, #EF5350); }
    .graficos-pizza .card, .card {
      height: auto;
      border: none;
      border-radius: 12px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .table-responsive { overflow-x: auto; }
  </style>
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>
<link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" rel="stylesheet"/>
</head>
<body>
<nav class="navbar fixed-top navbar-expand-lg">
<div class="container-fluid">
<a class="navbar-brand d-flex align-items-center" href="#">
<img alt="Logo Raízes Formativas" class="me-2" height="50" src="https://escolavirtual.educacao.go.gov.br/pluginfile.php/1025398/mod_page/content/1/logorf.png"/>
</a>
<div class="collapse navbar-collapse">
<ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
<a class="nav-link" href="index.html">Progresso no Curso</a>
</li>
<li class="nav-item">
<a aria-current="page" class="nav-link active" href="modulos.html">Módulos dos Cursos</a>
</li>
</ul>
</div>
</div>
</nav>
<div class="container">
<center>
<h4 style="color: #008ffb;">Progresso dos cursistas em cada Módulo dos cursos.</h4>
<br/>
</center>
<div class="row mb-4">
<div class="col-md-6">
<div class="gradient-box bg-grad-1">
<h5>Curso com mais atividades concluídas:</h5>
<h3 id="cursoMaisAtividades">...</h3>
</div>
</div>
<div class="col-md-6">
<div class="gradient-box bg-grad-2">
<h5>Curso com menos módulos concluídos:</h5>
<h3 id="cursoMenosModulos">...</h3>
</div>
</div>
</div>
<div class="row graficos-pizza">
<div class="col-md-6">
<div class="card p-3">
<h6 class="text-center">Atividades concluídas por curso</h6>
<div id="graficoAtividadesCurso"></div>
</div>
</div>
<div class="col-md-6">
<div class="card p-3">
<h6 class="text-center">Módulos concluídos por curso</h6>
<div id="graficoModulosCurso"></div>
</div>
</div>
</div>
<div class="row">
<div class="col-md-12">
<div class="card p-3 mt-4">
<h6 class="text-center">Progresso semanal de conclusão de atividades</h6>
<div id="graficoProgressoSemanal"></div>
</div>
</div>
</div>
<div class="row mt-4">
<div class="col-md-12">
<div class="card p-3 table-responsive">
<table class="table table-bordered" id="tabelaModulos">
<thead><tr id="cabecalhoTabela"></tr></thead>
<tbody id="corpoTabela"></tbody>
</table>
</div>
</div>
</div>
</div>











<script>

// === MAPEAMENTO DE CURSOS PARA ARQUIVOS ===
const cursoMap = {
  "Formação de Professores de Língua Portuguesa": "progress.fplp25.csv",
  "Formação de Professores de Língua Inglesa": "progress.fpling25.csv",
  "Formação de Professores de Arte": "progress.fpart25.csv",
  "Formação de Professores de Química": "progress.fpqui25.csv",
  "Formação de Professores de Matemática": "progress.fpmat25.csv",
  "Formação de Professores de Física": "progress.fpfis25.csv",
  "Formação de Professores de Filosofia": "progress.fpfilo25.csv",
  "Formação de Professores de Sociologia": "progress.fpsocio25.csv",
  "Formação de Professores de Biologia": "progress.fpbio25.csv",
  "Formação de Professores de Geografia": "progress.fpgeo25.csv",
  "Formação de Professores de História": "progress.fphist25.csv",
  "Trilha Formativa: Formadores": "progress.trilha_formativa_formadores.csv"
};

document.addEventListener("DOMContentLoaded", async () => {
  const atividadesCurso = {};
  const modulosCurso = {};
  const progressoSemanal = {};
  const tabelaDados = [];

  const carregarCSV = (path) => {
    return new Promise((resolve) => {
      Papa.parse('cursos/' + path, {
        download: true,
        complete: (results) => resolve(results.data)
      });
    });
  };

  const processarCurso = async (nome, arquivo) => {
    const data = await carregarCSV(arquivo);
    const headers = data[0];
    const linhas = data.slice(1).filter(l => l[0]);

    const colAtividades = headers
      .map((h, i) => ({ header: h, index: i }))
      .filter(col => col.header && /(li[cç][aão]|f[oó]rum|discuss[aã]o)/i.test(col.header));

    let modulos = [];
    let moduloAtual = [];

    colAtividades.forEach(col => {
      if (/li[cç][aão] 1/i.test(col.header) && moduloAtual.length > 0) {
        modulos.push(moduloAtual);
        moduloAtual = [];
      }
      moduloAtual.push(col.index);
    });
    if (moduloAtual.length > 0) modulos.push(moduloAtual);

    const concluidos = linhas.map(row => {
      return modulos.map(mod => mod.filter(i => row[i + 1]).length); // i+1 pega a coluna de data
    });

    const totalPorModulo = concluidos.reduce((acc, cur) => {
      cur.forEach((v, i) => acc[i] = (acc[i] || 0) + (v > 0 ? 1 : 0));
      return acc;
    }, []);

    atividadesCurso[nome] = colAtividades.length;
    modulosCurso[nome] = modulos.length;

    linhas.forEach((linha, li) => {
      const nomeEstudante = linha[0];
      const email = linha[1];
      const progresso = concluidos[li];
      const totalAtiv = progresso.reduce((a, b) => a + b, 0);

      const linhaTabela = {
        Nome: nomeEstudante,
        Email: email,
        Curso: nome,
        ...Object.fromEntries(progresso.map((v, i) => [`Módulo ${i + 1}`, v])),
        Total: totalAtiv
      };

      tabelaDados.push(linhaTabela);
    });
  };

  for (const [nome, arquivo] of Object.entries(cursoMap)) {
    await processarCurso(nome, arquivo);
  }

  // GRÁFICOS
  new ApexCharts(document.querySelector("#graficoAtividadesCurso"), {
    chart: { type: 'pie' },
    series: Object.values(atividadesCurso),
    labels: Object.keys(atividadesCurso)
  }).render();

  new ApexCharts(document.querySelector("#graficoModulosCurso"), {
    chart: { type: 'pie' },
    series: Object.values(modulosCurso),
    labels: Object.keys(modulosCurso)
  }).render();

  // TABELA
  const colunas = Object.keys(tabelaDados[0]);
  const cabecalho = document.getElementById("cabecalhoTabela");
  cabecalho.innerHTML = colunas.map(c => `<th>${c}</th>`).join("");

  const corpo = document.getElementById("corpoTabela");
  corpo.innerHTML = tabelaDados.map(row => {
    return "<tr>" + colunas.map(k => `<td>${row[k]}</td>`).join("") + "</tr>";
  }).join("");

  if ($.fn.dataTable.isDataTable("#tabelaModulos")) {
    $('#tabelaModulos').DataTable().clear().destroy();
  }

  $('#tabelaModulos').DataTable({
    language: {
      url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json"
    },
    dom: 'Bfrtip',
    buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
  });

});
</script></body>
</html>
